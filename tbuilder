#!/bin/sh

PORTSDIR=${PORTSDIR:-/usr/ports}
PATH=$PATH:$PORTSDIR/Tools/scripts
TBDIR=${TBDIR:-/usr/local/tinderbox}
TBUSER=${TBUSER:-corn}
build=${3:-none}

# $1 tinderbox buildname, $2 port to build
build_queue_add() {
	local ptree="$TBDIR/portstrees/$(tc_cmd getPortsTreeForBuild -b $1)/ports"

	if [ ! -d "$ptree/$2" ]; then
		echo "$1: $2 does not exists"
		return	
	fi
	
	echo "Adding $2 to $1 build queue"
	tc_cmd addBuildPortsQueueEntry -u $TBUSER -b $1 -d $2
}

display_usage() {
	echo "Usage: tbuilder <command> <query> <build_name|all>"
	echo ""
	echo " commands: bdeps - build ports having <query> build dependency"
	echo "           grep  - build ports containing <query> port in Makefile"
	echo "           match - build port matching <query>"
	echo "           name  - build port <query>"
	echo "                   if <query> = "." build port from current directory"
	exit
}

tc_cmd() {
	local tc_script
	
	if [ "$(id -u)" = "0" ]; then
		tc_script="./tc"
	else
		tc_script="sudo ./tc"
	fi

	cd $TBDIR/scripts && $tc_script $*
}

case $1 in
bdeps)
	[ -z "$2" ] && display_usage
	ports=$(portsearch -b $2 | grep Path: | cut -f 4- -d '/') ;;
grep)
	ports=$(cd $PORTSDIR && find . -name "Makefile*" -exec grep -q "$2" {} \; \
		-print | grep -v "$2/Makefile" | sed -E 's;(\./|/Makefile);;g') ;;
match)
	[ -z "$2" ] && display_usage
	ports=$(portsearch -n $2 | grep Path: | cut -f 4- -d '/') ;;
name)
	[ -z "$2" -o $build = "none" ] && display_usage
	ports=$2
	[ "$ports" = "." ] && ports=$(echo $PWD | \
		awk '{ n = split($0, p ,"/"); print p[n-1] "/" p[n]; }')
	;;
*)
	display_usage
esac

for port in $ports; do
	case $build in
	none)
		echo "Found match: $port" ;;
	all)
		for b in $(tc_cmd listBuilds); do build_queue_add $b $port; done ;;
	*)
		build_queue_add $build $port
	esac
done
