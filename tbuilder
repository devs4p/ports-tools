#!/bin/sh

readonly POUDRIERE_DIR="${POUDRIERE_DIR:-/usr/local/poudriere}"
readonly POUDRIERE_PORTS="${POUDRIERE_PORTS:-${POUDRIERE_DIR}/ports/default}"

readonly command="${1}"
query="${2}"
readonly build="${3:-none}"

interrupted=0 # build interrupted by ctrl+c

check_portname() {
	if [ "${1}" = "." ]; then
		port="$(echo ${PWD} | awk '{
			n = split($0, p ,"/");
			print p[n-1] "/" p[n];
		}')"
	else
		port="${1}"
	fi

	if [ ! -d "${POUDRIERE_PORTS}/${port}" ]; then
		printf "===> ${POUDRIERE_PORTS}/${port}: port directory does not exists\n\n" >&2
		display_usage
	fi

	echo ${port}
}

display_usage() {
	<< EOF >&2 cat
Usage: ${0##*/} <command> <query> [jail_name] [poudriere testport args]

 command: bdeps  - build ports having certain build dependency
          file   - build ports read from file
          grep   - build ports containing phrase in Makefile
          ldeps  - build ports linking with certain library
          match  - build ports with name matching certain phrase
          name   - build specific port
          slaves - build slaves of certain port

 query: (bdeps|match) - portname
        (file) - name of file to read category/port entries from
        (grep) - grep pattern
        (ldeps|name|slaves) - category/port or '.' for port from current directory

 jail_name: poudriere jail name or 'all' for all available jails

EOF
	exit 1
}

is_build_dep() {
	[ "$(make -V BUILD_DEPENDS -V LIB_DEPENDS ${2} \
		| grep ${1})" ] && return 0 || return 1
}

is_other_dep() {
	[ "$(make -V FETCH_DEPENDS -V EXTRACT_DEPENDS -V PATCH_DEPENDS \
		-V RUN_DEPENDS -V TEST_DEPENDS ${2} | grep ${1})" ] &&
		return 0 || return 1
}

poudriere_jails() {
	poudriere jail -lq | cut -d" " -f1
}

poudriere_test_build() {
	local jname="${1}" port="${2%%:*}" option=${2#*:}
	local port_cfg outcome="success"

	if [ "${port}" != "${option}" ]; then
		if [ "${option%:*}" != "OPT_UNKNOWN"  ]; then
			echo "*** port ${port} needs ${option%:*} set to ${option#*:} ***"
		else
			echo "*** port ${port} unknown option needed ***"
		fi
		port_cfg="-c"
	fi

	${SUDO} poudriere testport -j ${jname} -o ${port} ${poudriere_args} ${port_cfg}
	[ ${?} -eq 0 ] || outcome="failed"
	[ ${interrupted} -eq 0 ] || outcome="interrupted"
	BUILD_RESULTS="${BUILD_RESULTS} ${port}:${jname}:${outcome}"
}

[ "${query}" ] || display_usage

if [ "${build}" != "none" -a "${build}" != "all" \
	-a -z "$(poudriere_jails | grep ${build})" ]
then
	printf "===> ${build}: no such poudriere jail\n\n" >&2
	display_usage
fi

if [ "${4}" ]; then
	shift 3;
	poudriere_args="${*}";
fi

if [ ! -d "${POUDRIERE_PORTS}" ]; then
	echo "===> Poudriere ports directory not found: ${POUDRIERE_PORTS}" >&2
	echo "===> Try setting POUDRIERE_PORTS enviroment variable" >&2
	exit 1
fi

if [ $(id -u) -ne 0 ]; then
	if ! which sudo >/dev/null; then
		echo "===> sudo not found" >&2
		exit 1
	fi
	SUDO="sudo"
fi

trap 'interrupted=1' int

case ${command} in
bdeps)
	ports="$(pfind -b ${query})" ;;
file)
	if [ ! -f "${query}" ]; then
		echo "===> File ${query} does not exists" >&2
		exit 1
	fi
	ports="$(cat "${query}" | grep -v '^#')" ;;
grep)
	ports="$(cd ${POUDRIERE_PORTS} && find . -name "Makefile*" -exec \
		grep -q "${query}" {} \; -print | grep -v "${query}/Makefile" |
		sed -E 's;(\./|/Makefile);;g')" ;;
ldeps)
	query=$(check_portname ${query})
	tmp="$(cd ${POUDRIERE_PORTS} && find . -name "Makefile*" -exec grep -q \
		"^[^#].*${query}[ \\]*\$" {} \; -print | sed 's|\./||')"

	for path in ${tmp}; do
		path="$(dirname ${path})"
		[ "${query}" != "${path}" ] || continue
		cd ${POUDRIERE_PORTS}/${path}
		if is_build_dep ${query}; then
			ports="${ports} ${path}"
			continue
		fi
		is_other_dep ${query} && continue

		for option in $(make pretty-print-config); do
			case ${option} in -*)
				if is_build_dep ${query} OPTIONS_DEFAULT=${option#-}; then
					ports="${ports} ${path}:${option#-}:on"
					continue 2
				fi
				is_other_dep ${query} OPTIONS_DEFAULT=${option#-} && continue 2
			esac
		done
		for option in $(make pretty-print-config); do
			case ${option} in +*)
				if is_build_dep ${query} OPTIONS_UNSET=${option#+}; then
					ports="${ports} ${path}:${option#+}:off"
					continue 2
				fi
			esac
		done
		ports="${ports} ${path}:OPT_UNKNOWN:none"
	done
	;;
match)
	ports="$(pfind -n ${query})" ;;
name)
	ports=$(check_portname ${query}) ;;
slaves)
	master=$(check_portname ${query})
	ports=$(pfind -s ${master}) ;;
*)
	display_usage
esac

for port in ${ports}; do
	case ${build} in
	none)
		option=${port#*:}
		if [ "${command}" != "name" ]; then
			case ${option%:*} in
			"${port%%:*}")
				echo "Found match: ${port%%:*}" ;;
			"OPT_UNKNOWN")
				echo "Found match: ${port%%:*}, unknown option needed" ;;
			*)
				echo "Found match: ${port%%:*}, needs ${option%:*}=${option#*:}" ;;
			esac
		fi
		;;
	all)
		for b in $(poudriere_jails | sort -h); do
			poudriere_test_build ${b} ${port}
			[ ${interrupted} -eq 0 ] || break 2
		done ;;
	*)
		poudriere_test_build ${build} ${port}
		[ ${interrupted} -eq 0 ] || break
	esac
done

if [ "${BUILD_RESULTS}" ]; then
	printf "\n===> Following build(s) were performed:\n"
	printf "%-40s %-15s %s\n" "PORTNAME" "JAIL" "RESULT"

	for result in ${BUILD_RESULTS}; do
		params=${result#*:}
		printf "%-40s %-15s %s\n" "${result%%:*}" \
			${params%:*} ${params#*:}
	done
	echo ""
fi

